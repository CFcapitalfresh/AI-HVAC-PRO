# -*- coding: utf-8 -*-
"""
CORE: SPY LOGGER (ÎŸ ÎšÎ‘Î¤Î‘Î£ÎšÎŸÎ ÎŸÎ£)
-------------------------------
Captures system logs and displays them in Streamlit Sidebar.
Version: 1.2 (Drive Persistence Edition) - ÎÎ•ÎŸ: Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏƒÏ„Î¿ Google Drive.
"""
import logging
import streamlit as st
import datetime
# Î¤Î¿ DatabaseConnector Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Ï€Î»Î­Î¿Î½ Î³Î¹Î± Ï„Î¹Ï‚ Î¼ÎµÎ¸ÏŒÎ´Î¿Ï…Ï‚ Ï„Î¿Ï… Drive
from core.db_connector import DatabaseConnector 
from typing import Optional # Î“Î¹Î± type hinting

logger = logging.getLogger("Core.Spy") # Ensure logger name is consistent

class StreamlitSpyHandler(logging.Handler):
    """ÎˆÎ½Î±Ï‚ ÎµÎ¹Î´Î¹ÎºÏŒÏ‚ 'Ï€ÏÎ¬ÎºÏ„Î¿ÏÎ±Ï‚' Ï€Î¿Ï… ÎºÎ»Î­Î²ÎµÎ¹ Ï„Î± logs ÎºÎ±Î¹ Ï„Î± Î²Î¬Î¶ÎµÎ¹ ÏƒÏ„Î¿ Session State."""
    
    def emit(self, record):
        try:
            timestamp = datetime.datetime.now().strftime("%H:%M:%S")
            msg = self.format(record)
            
            # Î•Î¹ÎºÎ¿Î½Î¯Î´Î¹Î± Î³Î¹Î± ÎµÏÎºÎ¿Î»Î· Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·
            icon = "â„¹ï¸"
            if record.levelno == logging.WARNING: icon = "âš ï¸"
            elif record.levelno == logging.INFO and ("Success" in msg or "âœ…" in msg): icon = "âœ…"
            elif record.levelno == logging.ERROR: icon = "âŒ"
            elif record.levelno == logging.CRITICAL: icon = "ğŸ”¥"
            elif "Vision" in msg or "Gemini" in record.name: icon = "ğŸ‘ï¸" # More specific for AI
            elif "Drive" in msg or "Drive" in record.name: icon = "ğŸ“‚" # More specific for Drive
            elif "Spy" in record.name: icon = "ğŸ•µï¸" # Î“Î¹Î± Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… logs Ï„Î¿Ï… Spy
            elif "DEBUG" in record.levelname: icon = "ğŸ›" # Debug icon
            
            entry = f"`{timestamp}` {icon} **{record.name}:** {msg}"
            
            # Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏƒÏ„Î· Î¼Î½Î®Î¼Î· Ï„Î¿Ï… Streamlit
            if "spy_logs" not in st.session_state:
                st.session_state.spy_logs = []
            
            # ÎšÏÎ±Ï„Î¬Î¼Îµ Ï„Î± Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± 100 logs (ÎÎ­Î± Ï€Î¬Î½Ï‰)
            st.session_state.spy_logs.insert(0, entry)
            if len(st.session_state.spy_logs) > 100:
                st.session_state.spy_logs.pop()
            
        except Exception:
            self.handleError(record)

def setup_spy():
    """Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿Î½ ÎºÎ±Ï„Î¬ÏƒÎºÎ¿Ï€Î¿ ÏƒÏ„Î¿ Î¾ÎµÎºÎ¯Î½Î·Î¼Î±."""
    if "spy_active" not in st.session_state:
        # Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Ï„Î¿Ï… Î²Î±ÏƒÎ¹ÎºÎ¿Ï Logger
        root_logger = logging.getLogger()
        root_logger.setLevel(logging.INFO)
        
        # ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï€Î±Î»Î¹ÏÎ½ handlers Î³Î¹Î± Î½Î± Î¼Î·Î½ Î­Ï‡Î¿Ï…Î¼Îµ Î´Î¹Ï€Î»Î¬ Î¼Î·Î½ÏÎ¼Î±Ï„Î±
        root_logger.handlers = [h for h in root_logger.handlers if not isinstance(h, StreamlitSpyHandler)]
        
        # Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï„Î¿Ï… Î´Î¹ÎºÎ¿Ï Î¼Î±Ï‚ Handler
        spy = StreamlitSpyHandler()
        formatter = logging.Formatter('%(message)s')
        spy.setFormatter(formatter)
        root_logger.addHandler(spy)
        
        st.session_state.spy_active = True
        
        # REMOVED: Î”ÎµÎ½ Ï†Î¿ÏÏ„ÏÎ½Î¿Ï…Î¼Îµ Ï€Î»Î­Î¿Î½ logs Î±Ï€ÏŒ SQLite
        st.session_state.spy_logs = [] # Ensure it's initialized
        st.session_state.spy_logs.insert(0, "`System` ğŸ•µï¸ ÎŸ ÎšÎ±Ï„Î¬ÏƒÎºÎ¿Ï€Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ ÎŸnline (Ï„Î± logs Ï„ÏÏÎ± Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ ÏƒÏ„Î¿ Drive).")

def sync_current_spy_logs_to_drive() -> Optional[str]: # NEW
    """
    Î£Ï…Î³Ï‡ÏÎ¿Î½Î¯Î¶ÎµÎ¹ Ï„Î± Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± logs Ï„Î¿Ï… Spy Logger ÏƒÏ„Î¿ Google Drive.
    Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Ï„Î¿ link Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï… ÏƒÏ„Î¿ Drive.
    """
    if "spy_logs" in st.session_state and st.session_state.spy_logs:
        # ÎšÎ¬Î½Î¿Ï…Î¼Îµ Î¼Î¹Î± shallow copy Ï„Î·Ï‚ Î»Î¯ÏƒÏ„Î± Î³Î¹Î± Î½Î± Î±Ï€Î¿Ï†ÏÎ³Î¿Ï…Î¼Îµ Ï€ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î± Î±Î½ Î±Î»Î»Î¬Î¾ÎµÎ¹ ÎºÎ±Ï„Î¬ Ï„Î· Î¼ÎµÏ„Î±Ï†ÏŒÏÏ„Ï‰ÏƒÎ·
        log_link = DatabaseConnector.upload_spy_logs_to_drive(list(st.session_state.spy_logs)) 
        return log_link
    logger.info("No spy logs found in session state to upload.")
    return None