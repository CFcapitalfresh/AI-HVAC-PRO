"""
MODULE: UI SEARCH (CONNECTED)
-----------------------------
Description: Streamlit UI wrapper for the Global Library Search,
now leveraging app_modules/search_engine.py for core UI/Search logic.
"""
import streamlit as st
from services.sync_service import SyncService
from core.language_pack import get_text
from app_modules.search_engine import render_search_page as core_render_search_page # Import the core search UI

def render(user):
    lang = st.session_state.get('lang', 'gr')
    srv = SyncService()
    
    st.header(get_text('menu_library', lang))
    
    # --- SYNC BUTTON ---
    if st.button("ğŸ”„ Sync Library / Î‘Î½Î±Î½Î­Ï‰ÏƒÎ· Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·Ï‚", use_container_width=True):
        with st.spinner("â³ Î£Î¬ÏÏ‰ÏƒÎ· Drive & Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î•Ï…ÏÎµÏ„Î·ÏÎ¯Î¿Ï…..."):
            try:
                data = srv.scan_library() # Î‘Ï…Ï„ÏŒ Ï„ÏÏÎ± ÏƒÏÎ¶ÎµÎ¹ ÎºÎ±Î¹ ÏƒÏ„Î¿ Cloud
                st.session_state.library_cache = data
                st.success(f"âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ! Î¤Î¿ ÎµÏ…ÏÎµÏ„Î®ÏÎ¹Î¿ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ. ({len(data)} Î±ÏÏ‡ÎµÎ¯Î±)")
            except Exception as e:
                st.error(f"âŒ Error during library sync: {e}")
                
        st.rerun() # Force rerun to clear spinner and update search page

    st.divider()

    # --- SMART LOAD ---
    # Rule 6: Streamlit State (ensure library_cache is loaded once or cached)
    if 'library_cache' not in st.session_state or not st.session_state.library_cache:
        with st.spinner("â˜ï¸ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·Ï‚..."):
            try:
                st.session_state.library_cache = srv.load_index()
                if not st.session_state.library_cache:
                    st.info(f"â„¹ï¸ {get_text('lic_admin_no_licenses', lang)} Î Î±Ï„Î®ÏƒÏ„Îµ 'Sync' Î³Î¹Î± Î±ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·.") # Re-using key
            except Exception as e:
                st.error(f"âŒ Error loading library index: {e}")
                st.session_state.library_cache = [] # Ensure it's a list even on error
                
    data = st.session_state.get('library_cache', [])
    
    # --- DELEGATE TO CORE SEARCH UI ---
    # Rule 3: Modularity - The UI module delegates the complex rendering
    # and search logic to the app_modules.
    try:
        core_render_search_page(data)
    except Exception as e:
        st.error(f"{get_text('general_ui_error', lang).format(error=e)}")
        logger.error(f"Error rendering search page: {e}", exc_info=True)