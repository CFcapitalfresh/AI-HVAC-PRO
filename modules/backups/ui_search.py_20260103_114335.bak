"""
MODULE: UI SEARCH (CONNECTED)
-----------------------------
Description: Streamlit UI wrapper for the Global Library Search,
now leveraging app_modules/search_engine.py for core UI/Search logic.
"""
import streamlit as st
from services.sync_service import SyncService
from core.language_pack import get_text
from app_modules.search_engine import render_search_page as core_render_search_page # Import the core search UI
import logging

logger = logging.getLogger("Module_Search_UI") # Logger for this UI module

def render(user):
    lang = st.session_state.get('lang', 'gr')
    
    # Cache SyncService instance (Rule 6)
    if 'sync_service_instance_search' not in st.session_state:
        st.session_state.sync_service_instance_search = SyncService()
    srv = st.session_state.sync_service_instance_search
    
    # Removed header here as core_render_search_page handles it now.
    # st.header(get_text('menu_library', lang)) # This should be handled by the core search module
    
    # --- SYNC BUTTON ---
    if st.button(get_text('search_lib_sync_btn', lang), use_container_width=True):
        with st.spinner(get_text('search_sync_spinner', lang)):
            try:
                data = srv.scan_library() # Αυτό τώρα σώζει και στο Cloud
                st.session_state.library_cache = data
                st.success(get_text('search_sync_success', lang).format(count=len(data)))
                logger.info(f"UI Search: Library sync completed successfully. {len(data)} files indexed.")
            except Exception as e:
                logger.error(f"UI Search: Error during library sync: {e}", exc_info=True)
                st.error(get_text('search_sync_error', lang).format(error=e))
                
        st.rerun() # Force rerun to clear spinner and update search page

    st.divider()

    # --- SMART LOAD ---
    # Rule 6: Streamlit State (ensure library_cache is loaded once or cached)
    if 'library_cache' not in st.session_state or not st.session_state.library_cache:
        with st.spinner(get_text('search_load_spinner', lang)):
            try:
                st.session_state.library_cache = srv.load_index()
                if not st.session_state.library_cache:
                    st.info(get_text('search_no_data', lang)) 
                    logger.info("UI Search: No library data found, prompting user to sync.")
            except Exception as e:
                logger.error(f"UI Search: Error loading library index: {e}", exc_info=True)
                st.error(get_text('search_sync_error', lang).format(error=e)) # Re-using key
                st.session_state.library_cache = [] # Ensure it's a list even on error
                
    data = st.session_state.get('library_cache', [])
    
    # --- DELEGATE TO CORE SEARCH UI ---
    # Rule 3: Modularity - The UI module delegates the complex rendering
    # and search logic to the app_modules.
    try:
        core_render_search_page(data)
    except Exception as e:
        logger.error(f"UI Search: Error rendering search page: {e}", exc_info=True)
        st.error(f"{get_text('general_ui_error', lang).format(error=e)}") # Κανόνας 5...