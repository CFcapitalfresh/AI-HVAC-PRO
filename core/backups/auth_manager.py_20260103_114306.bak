import streamlit as st
import bcrypt
from core.db_connector import DatabaseConnector
from datetime import datetime
import logging

logger = logging.getLogger("Core.Auth")

class AuthManager:
    @staticmethod
    def verify_login(email: str, password: str, use_local_db_for_check: bool = False):
        """
        Ελέγχει τα στοιχεία εισόδου.
        Περιλαμβάνει καθαρισμό (trim) για κινητά και υποστήριξη τοπικής βάσης.
        Args:
            email (str): Email του χρήστη.
            password (str): Κωδικός χρήστη.
            use_local_db_for_check (bool): Αν είναι True, ελέγχει πρώτα την τοπική βάση.
        Returns:
            tuple: (user_data: dict, message: str)
        """
        # 1. ΚΑΘΑΡΙΣΜΟΣ INPUT (Αυτό λύνει το πρόβλημα του κινητού)
        if email:
            email = email.strip().lower()
        else:
            return None, "Email required"
            
        if password:
            password = password.strip()
        else:
            return None, "Password required"

        user_data = None
        source_db = "Google Sheets"

        # 2. ΕΛΕΓΧΟΣ ΑΠΟ ΤΟΠΙΚΗ ΒΑΣΗ (αν ζητηθεί)
        if use_local_db_for_check:
            local_users_df = DatabaseConnector.fetch_data("Users", use_local_db=True)
            if not local_users_df.empty:
                local_user = local_users_df[local_users_df['email'] == email]
                if not local_user.empty:
                    user_data = local_user.iloc[0]
                    source_db = "SQLite Local"
                    logger.info(f"User '{email}' found in local SQLite.")

        # 3. ΕΛΕΓΧΟΣ ΑΠΟ CLOUD ΒΑΣΗ (αν δεν βρέθηκε τοπικά ή αν δεν ζητήθηκε τοπικός έλεγχος)
        if user_data is None:
            users_df = DatabaseConnector.fetch_data("Users") # GSheets
            if not users_df.empty:
                cloud_user = users_df[users_df['email'] == email]
                if not cloud_user.empty:
                    user_data = cloud_user.iloc[0]
                    source_db = "Google Sheets"
                    logger.info(f"User '{email}' found in Google Sheets.")
            else:
                return None, "No users found in database(s)"

        if user_data is None: 
            return None, "User not found"
        
        stored_hash = user_data['password_hash']
        
        # 4. ΕΛΕΓΧΟΣ ΚΩΔΙΚΟΥ
        try:
            # Περίπτωση Α: Παλιός κωδικός (απλό κείμενο - Legacy)
            if not stored_hash.startswith('$2b$'):
                if stored_hash == password:
                    if user_data['role'] == 'active' or user_data['role'] == 'admin':
                        logger.info(f"User '{email}' logged in successfully from {source_db}.")
                        return user_data.to_dict(), "OK"
                    else:
                        logger.warning(f"Login failed for '{email}': Account pending approval.")
                        return None, "Account Pending Approval"
                else:
                    logger.warning(f"Login failed for '{email}'. Wrong password (legacy check).")
                    return None, "Wrong password"
            
            # Περίπτωση Β: Νέος ασφαλής κωδικός (Hash - Bcrypt)
            if bcrypt.checkpw(password.encode('utf-8'), stored_hash.encode('utf-8')):
                if user_data['role'] == 'active' or user_data['role'] == 'admin':
                    logger.info(f"User '{email}' logged in successfully from {source_db}.")
                    return user_data.to_dict(), "OK"
                else:
                    logger.warning(f"Login failed for '{email}': Account pending approval.")
                    return None, "Account Pending Approval"
            else:
                logger.warning(f"Failed login attempt for '{email}'. Wrong password (bcrypt check).")
                return None, "Wrong password"
        except Exception as e:
            logger.error(f"Auth Error for '{email}': {str(e)}", exc_info=True)
            return None, f"Auth Error: {str(e)}"

    @staticmethod
    def register_new_user(email: str, name: str, password: str) -> bool:
        """
        Εγγράφει νέο χρήστη ως 'pending' στα Google Sheets.
        Επίσης, προσθέτει τον χρήστη στην τοπική SQLite βάση ως 'pending' για μελλοντική χρήση.
        """
        # 1. ΚΑΘΑΡΙΣΜΟΣ INPUT
        if email: email = email.strip().lower()
        if name: name = name.strip()
        if password: password = password.strip()

        if not email or not password:
            logger.warning("Attempted registration with missing email or password.")
            return False

        # 2. ΕΛΕΓΧΟΣ ΑΝ ΥΠΑΡΧΕΙ ΗΔΗ ΣΕ GSheets
        try:
            users_gsheets = DatabaseConnector.fetch_data("Users")
            if not users_gsheets.empty and email in users_gsheets['email'].values:
                logger.warning(f"Registration attempt for existing email: {email}")
                st.warning("Το email υπάρχει ήδη. Παρακαλώ συνδεθείτε ή χρησιμοποιήστε διαφορετικό email.")
                return False 
        except Exception as e:
            logger.error(f"Error checking existing users in GSheets during registration: {e}", exc_info=True)
            st.error("Σφάλμα κατά τον έλεγχο χρηστών. Παρακαλώ δοκιμάστε ξανά αργότερα.")
            return False
            
        # 3. ΚΡΥΠΤΟΓΡΑΦΗΣΗ (HASHING)
        try:
            hashed = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
        except Exception as e:
            logger.error(f"Error hashing password for {email}: {e}", exc_info=True)
            st.error("Σφάλμα κρυπτογράφησης κωδικού. Παρακαλώ δοκιμάστε ξανά.")
            return False
        
        # 4. ΔΗΜΙΟΥΡΓΙΑ ΕΓΓΡΑΦΗΣ
        new_user_data = [
            str(datetime.now()), 
            email,
            name,
            hashed,
            "pending" # Role (Μπαίνει ως 'pending' και θέλει έγκριση από Admin)
        ]
        
        # 5. ΑΠΟΘΗΚΕΥΣΗ ΣΕ GSheets
        try:
            success_gsheets = DatabaseConnector.append_data("Users", new_user_data)
            if not success_gsheets:
                logger.error(f"Failed to append new user {email} to Google Sheets.")
                return False
        except Exception as e:
            logger.error(f"Error appending new user {email} to Google Sheets: {e}", exc_info=True)
            return False

        # 6. ΑΠΟΘΗΚΕΥΣΗ ΣΕ ΤΟΠΙΚΗ ΒΑΣΗ (για συνέπεια)
        try:
            success_sqlite = DatabaseConnector.append_data("Users", new_user_data, use_local_db=True)
            if not success_sqlite:
                logger.warning(f"Failed to append new user {email} to local SQLite DB.")
                # Non-critical failure, GSheets is primary
        except Exception as e:
            logger.error(f"Error appending new user {email} to local SQLite DB: {e}", exc_info=True)
            # Non-critical failure

        logger.info(f"User '{email}' registered successfully as pending.")
        return True

    @staticmethod
    def log_interaction(user_email: str, action: str, description: str):
        """
        Καταγράφει μια αλληλεπίδραση χρήστη στο φύλλο "Logs".
        """
        try:
            log_entry_values = [
                datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                user_email,
                action,
                description
            ]
            # Προσθήκη σε Google Sheets (Cloud)
            DatabaseConnector.append_data("Logs", log_entry_values, use_local_db=False)
            # Προσθήκη σε SQLite (Local)
            DatabaseConnector.append_data("Logs", log_entry_values, use_local_db=True)
            logger.debug(f"Logged interaction: {action} by {user_email}")
        except Exception as e:
            logger.error(f"Error logging interaction for {user_email}: {e}", exc_info=True)
            # st.error(f"Error logging interaction: {e}") # Avoid showing this to users unless critical