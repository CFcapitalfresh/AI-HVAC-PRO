import os
import argparse # ÎÎ•ÎŸ: Î“Î¹Î± Î¿ÏÎ¯ÏƒÎ¼Î±Ï„Î± Î³ÏÎ±Î¼Î¼Î®Ï‚ ÎµÎ½Ï„Î¿Î»ÏÎ½

def scan_project(generate_map: bool, generate_code: bool):
    """
    Î£Î±ÏÏÎ½ÎµÎ¹ Ï„Î¿ project ÎºÎ±Î¹ Ï€Î±ÏÎ¬Î³ÎµÎ¹ Ï„Î¿ Ï‡Î¬ÏÏ„Î· Î±ÏÏ‡ÎµÎ¯Ï‰Î½ ÎºÎ±Î¹/Î® Ï„Î¿Î½ Ï€Î»Î®ÏÎ· ÎºÏÎ´Î¹ÎºÎ±.
    Args:
        generate_map (bool): Î‘Î½ Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸ÎµÎ¯ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ PROJECT_MAP.txt.
        generate_code (bool): Î‘Î½ Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸ÎµÎ¯ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ FULL_PROJECT_CODE.txt.
    """
    project_map_filename = "PROJECT_MAP.txt"
    full_code_filename = "FULL_PROJECT_CODE.txt"
    
    # Î¦Î¬ÎºÎµÎ»Î¿Î¹ Ï€Î¿Ï… Î‘Î“ÎÎŸÎŸÎ¥ÎœÎ• (Î³Î¹Î± Î½Î± Î¼Î·Î½ Î³ÎµÎ¼Î¯ÏƒÎµÎ¹ ÏƒÎºÎ¿Ï…Ï€Î¯Î´Î¹Î±)
    ignore_dirs = {'.git', '__pycache__', 'venv', 'env', '.venv', '.streamlit'}
    
    # Î¤ÏÏ€Î¿Î¹ Î±ÏÏ‡ÎµÎ¯Ï‰Î½ Ï€Î¿Ï… Î¸ÎµÏ‚ Î½Î± Î´Î¹Î±Î²Î¬ÏƒÏ‰ (Î•ÎÎ—ÎœÎ•Î¡Î©ÎœÎ•ÎÎŸÎ™)
    valid_extensions = {
        '.py', '.txt', '.md', '.toml', # Î¥Ï€Î¬ÏÏ‡Î¿Î½Ï„ÎµÏ‚
        '.json', '.yml', '.yaml', '.env', # ÎÎ•ÎŸÎ™: Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚/Î”ÎµÎ´Î¿Î¼Î­Î½Î±
        '.css', '.html', '.js' # ÎÎ•ÎŸÎ™: Frontend
    }

    print("ğŸ”„ ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· ÏƒÎ¬ÏÏ‰ÏƒÎ· Ï„Î¿Ï… project...")
    
    all_filepaths = []
    
    # Î ÏÏÏ„Î¿ Ï€Î­ÏÎ±ÏƒÎ¼Î±: Î£Ï…Î»Î»Î­Î³Î¿Ï…Î¼Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î´Î¹Î±Î´ÏÎ¿Î¼Î­Ï‚ Î±ÏÏ‡ÎµÎ¯Ï‰Î½ Ï€Î¿Ï… Ï€Î»Î·ÏÎ¿ÏÎ½ Ï„Î± ÎºÏÎ¹Ï„Î®ÏÎ¹Î±
    for root, dirs, files in os.walk("."):
        # Î‘Ï†Î±Î¹ÏÎ¿ÏÎ¼Îµ Ï„Î¿Ï…Ï‚ Ï†Î±ÎºÎ­Î»Î¿Ï…Ï‚ Ï€Î¿Ï… Î´ÎµÎ½ Î¸Î­Î»Î¿Ï…Î¼Îµ
        dirs[:] = [d for d in dirs if d not in ignore_dirs]
        
        for file in files:
            filepath = os.path.join(root, file)
            
            # Î•Î¾Î±Î¹ÏÎ¿ÏÎ¼Îµ Ï„Î¿ Î¯Î´Î¹Î¿ Ï„Î¿ scanner.py Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î±
            if file == os.path.basename(__file__):
                continue
            # Î•Î¾Î±Î¹ÏÎ¿ÏÎ¼Îµ Ï„Î± Î±ÏÏ‡ÎµÎ¯Î± ÎµÎ¾ÏŒÎ´Î¿Ï… Î±Ï€ÏŒ Ï„Î¿ Î½Î± ÏƒÎ±ÏÏ‰Î¸Î¿ÏÎ½ (Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Ï€ÏŒ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· ÎµÎºÏ„Î­Î»ÎµÏƒÎ·)
            if file == project_map_filename or file == full_code_filename:
                continue

            # Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Ï„Î·Î½ ÎºÎ±Ï„Î¬Î»Î·Î¾Î· Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï…
            if any(file.endswith(ext) for ext in valid_extensions):
                all_filepaths.append(filepath)

    # Î¤Î±Î¾Î¹Î½Î¿Î¼Î¿ÏÎ¼Îµ Ï„Î¹Ï‚ Î´Î¹Î±Î´ÏÎ¿Î¼Î­Ï‚ Î±Î»Ï†Î±Î²Î·Ï„Î¹ÎºÎ¬ Î³Î¹Î± ÏƒÏ…Î½ÎµÏ€Î® Î­Î¾Î¿Î´Î¿
    sorted_filepaths = sorted(all_filepaths)

    # --- Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PROJECT_MAP.txt ---
    if generate_map:
        print(f"ğŸ“„ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï‡Î¬ÏÏ„Î· project: '{project_map_filename}'...")
        with open(project_map_filename, "w", encoding="utf-8") as outfile:
            for filepath in sorted_filepaths:
                outfile.write(f"{filepath}\n")
        print(f"âœ… ÎŸ Ï‡Î¬ÏÏ„Î·Ï‚ project Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿: '{project_map_filename}'")

    # --- Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± FULL_PROJECT_CODE.txt ---
    if generate_code:
        print(f"ğŸ“„ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï€Î»Î®ÏÎ¿Ï…Ï‚ ÎºÏÎ´Î¹ÎºÎ± project: '{full_code_filename}'...")
        with open(full_code_filename, "w", encoding="utf-8") as outfile:
            for filepath in sorted_filepaths: # Î•Ï€Î±Î½Î±Î»Î±Î¼Î²Î¬Î½Î¿Ï…Î¼Îµ Ï„Î¹Ï‚ Ï„Î±Î¾Î¹Î½Î¿Î¼Î·Î¼Î­Î½ÎµÏ‚ Î´Î¹Î±Î´ÏÎ¿Î¼Î­Ï‚
                print(f"    Î”Î¹Î¬Î²Î±ÏƒÎ¼Î±: {filepath}")
                
                # Î“ÏÎ¬Ï†Î¿Ï…Î¼Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï… Î¼Îµ Ï„Î¿ Î½Î­Î¿ format
                outfile.write(f"\n{'='*50}\n")
                outfile.write(f"--- FILE: {filepath} ---\n")
                outfile.write(f"{'='*50}\n")
                
                # Î“ÏÎ¬Ï†Î¿Ï…Î¼Îµ Ï„Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿
                try:
                    with open(filepath, "r", encoding="utf-8") as infile:
                        outfile.write(infile.read())
                except Exception as e:
                    outfile.write(f"âŒ Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï… '{filepath}': {str(e)}")
                
                outfile.write("\n")
        print(f"âœ… ÎŸ Ï€Î»Î®ÏÎ·Ï‚ ÎºÏÎ´Î¹ÎºÎ±Ï‚ project Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿: '{full_code_filename}'")

    # ÎœÎ®Î½Ï…Î¼Î± Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚ Î® Ï€ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ Î±Î½ Î´ÎµÎ½ Î­Î³Î¹Î½Îµ Ï„Î¯Ï€Î¿Ï„Î±
    if not generate_map and not generate_code:
        print("âš ï¸ Î”ÎµÎ½ ÎµÏ€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ ÎºÎ±Î¼Î¯Î± ÎµÎ½Î­ÏÎ³ÎµÎ¹Î± (Î¿ÏÏ„Îµ Ï‡Î¬ÏÏ„Î·Ï‚, Î¿ÏÏ„Îµ ÎºÏÎ´Î¹ÎºÎ±Ï‚).")
    else:
        print("\nâœ… Î— ÏƒÎ¬ÏÏ‰ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ.")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Î£Î±ÏÏÎ½ÎµÎ¹ Ï„Î¿ project ÎºÎ±Î¹ Ï€Î±ÏÎ¬Î³ÎµÎ¹ Î±ÏÏ‡ÎµÎ¯Î± Ï‡Î¬ÏÏ„Î· ÎºÎ±Î¹ ÎºÏÎ´Î¹ÎºÎ±.")
    parser.add_argument("--map-only", action="store_true", help="Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Î¼ÏŒÎ½Î¿ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ PROJECT_MAP.txt.")
    parser.add_argument("--code-only", action="store_true", help="Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Î¼ÏŒÎ½Î¿ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ FULL_PROJECT_CODE.txt.")
    parser.add_argument("--all", action="store_true", help="Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ ÎºÎ±Î¹ Ï„Î± Î´ÏÎ¿ Î±ÏÏ‡ÎµÎ¯Î± (Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î® Î±Î½ Î´ÎµÎ½ Î´Î¿Î¸Î¿ÏÎ½ Î¬Î»Î»Î± Î¿ÏÎ¯ÏƒÎ¼Î±Ï„Î±).")
    
    args = parser.parse_args()

    # ÎšÎ±Î¸Î¿ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï€Î¿Î¹ÎµÏ‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ Î¸Î± Î³Î¯Î½Î¿Ï…Î½
    # Î‘Î½ Î´ÎµÎ½ Î´Î¿Î¸Î¿ÏÎ½ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î± Î¿ÏÎ¯ÏƒÎ¼Î±Ï„Î±, Î· Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î® ÎµÎ¯Î½Î±Î¹ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸Î¿ÏÎ½ ÎºÎ±Î¹ Ï„Î± Î´ÏÎ¿ (--all)
    if not args.map_only and not args.code_only and not args.all:
        generate_map_flag = True
        generate_code_flag = True
    else:
        generate_map_flag = args.map_only or args.all
        generate_code_flag = args.code_only or args.all

    scan_project(generate_map_flag, generate_code_flag)