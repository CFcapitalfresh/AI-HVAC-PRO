import streamlit as st
from services.sorter_logic import SorterService, ALLOWED_CATEGORIES, ALLOWED_TYPES, IRRELEVANT_OR_UNKNOWN_FOLDER, DUPLICATES_FOLDER
from core.language_pack import get_text
from core.db_connector import DatabaseConnector
import logging
import pandas as pd
from datetime import datetime
from services.sync_service import SyncService # ÎÎ•ÎŸ: Î“Î¹Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¿Ï… library_cache

logger = logging.getLogger("Module_Organizer_UI")

def render(user):
    lang = st.session_state.get('lang', 'gr')
    st.header(get_text('menu_organizer', lang))
    
    st.markdown(f"""
    <div style='background-color: #f0f2f6; padding: 15px; border-radius: 10px; border-left: 5px solid #ff4b4b;'>
        {get_text('org_desc', lang)}
    </div>
    """, unsafe_allow_html=True)
    st.write("")

    # Only Admin can use the organizer
    if user['role'] != 'admin':
        st.warning("You must be an Administrator to use the AI Organizer.")
        return

    # Initialize session state for sorter flags and results
    if 'sorter_stop_flag' not in st.session_state: st.session_state['sorter_stop_flag'] = False
    if 'sorter_running' not in st.session_state: st.session_state['sorter_running'] = False
    if 'sorter_failed_files' not in st.session_state: st.session_state['sorter_failed_files'] = []
    if 'sorter_manual_review_files' not in st.session_state: st.session_state['sorter_manual_review_files'] = []
    if 'sorter_irrelevant_files' not in st.session_state: st.session_state['sorter_irrelevant_files'] = []
    if 'sorter_duplicate_files' not in st.session_state: st.session_state['sorter_duplicate_files'] = []
    if 'sorter_progress_data' not in st.session_state: st.session_state.sorter_progress_data = {"current": 0, "total": 0, "text": ""}
    if 'sorter_run_log' not in st.session_state: st.session_state.sorter_run_log = []
    if 'sorter_summary' not in st.session_state: st.session_state.sorter_summary = None

    # --- ÎÎ•ÎŸ: Session state Î³Î¹Î± Ï€ÎµÏÎ¹Î®Î³Î·ÏƒÎ· Î±ÏÏ‡ÎµÎ¯Ï‰Î½ ---
    if 'org_browse_level' not in st.session_state: st.session_state.org_browse_level = "categories"
    if 'org_selected_category' not in st.session_state: st.session_state.org_selected_category = None
    if 'org_selected_brand' not in st.session_state: st.session_state.org_selected_brand = None
    if 'org_selected_model' not in st.session_state: st.session_state.org_selected_model = None
    if 'org_selected_type' not in st.session_state: st.session_state.org_selected_type = None

    # --- Tabs for Organizer functionalities ---
    tab1, tab2, tab3, tab4 = st.tabs([
        "ğŸ“Š Î£ÏÎ½Î¿ÏˆÎ· & Î•ÎºÏ„Î­Î»ÎµÏƒÎ·", 
        "ğŸ” Î ÎµÏÎ¹Î®Î³Î·ÏƒÎ· Î‘ÏÏ‡ÎµÎ¯Ï‰Î½", 
        "âš ï¸ Î‘Î½Î±Î¸ÎµÏÏÎ·ÏƒÎ· / Î£Ï†Î¬Î»Î¼Î±Ï„Î±", 
        "ğŸ“œ Î Î»Î®ÏÎµÏ‚ Log"
    ])

    with tab1: # Summary & Execution
        st.divider()
        # --- Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î£Ï…Î½Î¿Ï€Ï„Î¹ÎºÏÎ½ Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ ---
        if st.session_state.sorter_summary:
            summary = st.session_state.sorter_summary
            st.subheader("ğŸ“Š Î£ÏÎ½Î¿ÏˆÎ· Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î±Ï‚ Î•ÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚")
            st.caption(f"Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·: {summary.get('last_run_timestamp', 'N/A')}")
            
            col1, col2, col3, col4, col5 = st.columns(5)
            col1.metric("Î£Î±ÏÏ‰Î¼Î­Î½Î± Î‘ÏÏ‡ÎµÎ¯Î±", summary.get('total_files_scanned', 0))
            col2.metric("Î•Ï€Î¹Ï„Ï…Ï‡ÏÏ‚ Î¤Î±Î¾Î¹Î½Î¿Î¼Î·Î¼Î­Î½Î±", summary.get('total_successfully_sorted', 0))
            col3.metric("Î“Î¹Î± Î§ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î¿ ÎˆÎ»ÎµÎ³Ï‡Î¿", summary.get('total_moved_to_manual_review', 0))
            col4.metric("Î†ÏƒÏ‡ÎµÏ„Î±/Î†Î³Î½Ï‰ÏƒÏ„Î±", summary.get('total_moved_to_irrelevant', 0))
            col5.metric("Î”Î¹Ï€Î»ÏŒÏ„Ï…Ï€Î±", summary.get('total_moved_to_duplicates', 0))

            if summary.get('total_successfully_sorted', 0) > 0:
                st.markdown("---")
                st.subheader("Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ® ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î•Ï€Î¹Ï„Ï…Ï‡ÏÎ½ Î¤Î±Î¾Î¹Î½Î¿Î¼Î®ÏƒÎµÏ‰Î½")
                
                tab_cat, tab_brand, tab_type = st.tabs(["ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚", "ÎœÎ¬ÏÎºÎµÏ‚", "Î¤ÏÏ€Î¿Î¹ Î•Î³Ï‡ÎµÎ¹ÏÎ¹Î´Î¯Ï‰Î½"])
                
                with tab_cat:
                    if summary['category_counts']:
                        df_categories = pd.DataFrame(summary['category_counts'].items(), columns=['ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±', 'Î Î»Î®Î¸Î¿Ï‚'])
                        st.dataframe(df_categories.sort_values(by='Î Î»Î®Î¸Î¿Ï‚', ascending=False), use_container_width=True, hide_index=True)
                        st.bar_chart(df_categories.set_index('ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±'))
                    else:
                        st.info("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚.")
                
                with tab_brand:
                    if summary['brand_counts']:
                        df_brands = pd.DataFrame(summary['brand_counts'].items(), columns=['ÎœÎ¬ÏÎºÎ±', 'Î Î»Î®Î¸Î¿Ï‚'])
                        st.dataframe(df_brands.sort_values(by='Î Î»Î®Î¸Î¿Ï‚', ascending=False), use_container_width=True, hide_index=True)
                        st.bar_chart(df_brands.set_index('ÎœÎ¬ÏÎºÎ±'))
                    else:
                        st.info("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± Î¼Î¬ÏÎºÎµÏ‚.")

                with tab_type:
                    if summary['type_counts']:
                        df_types = pd.DataFrame(summary['type_counts'].items(), columns=['Î¤ÏÏ€Î¿Ï‚ Î•Î³Ï‡ÎµÎ¹ÏÎ¹Î´Î¯Î¿Ï…', 'Î Î»Î®Î¸Î¿Ï‚'])
                        st.dataframe(df_types.sort_values(by='Î Î»Î®Î¸Î¿Ï‚', ascending=False), use_container_width=True, hide_index=True)
                        st.bar_chart(df_types.set_index('Î¤ÏÏ€Î¿Ï‚ Î•Î³Ï‡ÎµÎ¹ÏÎ¹Î´Î¯Î¿Ï…'))
                    else:
                        st.info("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± Ï„ÏÏ€Î¿Ï…Ï‚ ÎµÎ³Ï‡ÎµÎ¹ÏÎ¹Î´Î¯Ï‰Î½.")
            st.markdown("---")

        # --- Action Buttons (Start/Stop/Refresh) ---
        col_start, col_stop, col_refresh = st.columns(3)

        with col_start:
            if col_start.button(f"ğŸš€ {get_text('org_start', lang)}", type="primary", use_container_width=True, disabled=st.session_state['sorter_running']):
                st.session_state['sorter_running'] = True
                st.session_state['sorter_stop_flag'] = False # Reset stop flag
                # Clear previous results for a new run
                st.session_state['sorter_failed_files'] = [] 
                st.session_state['sorter_manual_review_files'] = [] 
                st.session_state['sorter_irrelevant_files'] = [] 
                st.session_state['sorter_duplicate_files'] = [] 
                st.session_state['sorter_run_log'] = [] 
                st.session_state.sorter_progress_data = {"current": 0, "total": 0, "text": ""} 
                st.rerun()

        with col_stop:
            if col_stop.button("ğŸ›‘ Î”Î¹Î±ÎºÎ¿Ï€Î®", type="secondary", use_container_width=True, disabled=not st.session_state['sorter_running']):
                st.session_state['sorter_stop_flag'] = True # Set flag to stop the sorter
                logger.info("Sorter stop flag set. Waiting for process to halt.")

        with col_refresh:
            if col_refresh.button("ğŸ”„ Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·", use_container_width=True, disabled=st.session_state['sorter_running']):
                st.rerun()

    with tab2: # Browse Organized Files
        st.subheader("ğŸ” Î ÎµÏÎ¹Î®Î³Î·ÏƒÎ· ÎŸÏÎ³Î±Î½Ï‰Î¼Î­Î½Ï‰Î½ Î‘ÏÏ‡ÎµÎ¯Ï‰Î½")
        st.caption("Î•Î¾ÎµÏÎµÏ…Î½Î®ÏƒÏ„Îµ Ï„Î·Î½ Î¹ÎµÏÎ±ÏÏ‡Î¯Î± Ï„Ï‰Î½ Ï„Î±Î¾Î¹Î½Î¿Î¼Î·Î¼Î­Î½Ï‰Î½ ÎµÎ³Ï‡ÎµÎ¹ÏÎ¹Î´Î¯Ï‰Î½.")
        
        # Load library_cache if not already loaded or if empty
        if 'library_cache' not in st.session_state or not st.session_state.library_cache:
            sync_service = SyncService()
            with st.spinner("Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÎµÏ…ÏÎµÏ„Î·ÏÎ¯Î¿Ï… Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·Ï‚..."):
                st.session_state.library_cache = sync_service.load_index()
            if not st.session_state.library_cache:
                st.info("Î— Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· ÎµÎ¯Î½Î±Î¹ ÎºÎµÎ½Î®. Î•ÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ Ï„Î¿Î½ Organizer Î® ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¯ÏƒÏ„Îµ Ï„Î· Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·.")
                return

        library_data = st.session_state.library_cache

        # Back button logic
        if st.session_state.org_browse_level != "categories":
            if st.button("â¬…ï¸ Î Î¯ÏƒÏ‰"):
                if st.session_state.org_browse_level == "brands":
                    st.session_state.org_browse_level = "categories"
                    st.session_state.org_selected_category = None
                elif st.session_state.org_browse_level == "models":
                    st.session_state.org_browse_level = "brands"
                    st.session_state.org_selected_brand = None
                elif st.session_state.org_browse_level == "types":
                    st.session_state.org_browse_level = "models"
                    st.session_state.org_selected_model = None
                elif st.session_state.org_browse_level == "files":
                    st.session_state.org_browse_level = "types"
                    st.session_state.org_selected_type = None
                st.rerun()
        
        st.markdown("---")

        if st.session_state.org_browse_level == "categories":
            st.markdown("#### Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:")
            categories = sorted(list(set(item.get('category') for item in library_data if item.get('category') and item.get('category') not in IGNORED_FOLDERS_TOP_LEVEL)))
            if categories:
                for cat in categories:
                    if st.button(f"ğŸ“ {cat.replace('_', ' ')}", key=f"cat_{cat}", use_container_width=True):
                        st.session_state.org_selected_category = cat
                        st.session_state.org_browse_level = "brands"
                        st.rerun()
            else:
                st.info("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚.")

        elif st.session_state.org_browse_level == "brands":
            st.markdown(f"#### ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±: **{st.session_state.org_selected_category.replace('_', ' ')}** - Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎœÎ¬ÏÎºÎ±:")
            brands = sorted(list(set(item.get('brand') for item in library_data if item.get('category') == st.session_state.org_selected_category and item.get('brand'))))
            if brands:
                for brand in brands:
                    if st.button(f"ğŸ­ {brand.replace('_', ' ')}", key=f"brand_{brand}", use_container_width=True):
                        st.session_state.org_selected_brand = brand
                        st.session_state.org_browse_level = "models"
                        st.rerun()
            else:
                st.info("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î¼Î¬ÏÎºÎµÏ‚ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±.")

        elif st.session_state.org_browse_level == "models":
            st.markdown(f"#### ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±: **{st.session_state.org_selected_category.replace('_', ' ')}** > **{st.session_state.org_selected_brand.replace('_', ' ')}** - Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎœÎ¿Î½Ï„Î­Î»Î¿:")
            models = sorted(list(set(item.get('model') for item in library_data if item.get('category') == st.session_state.org_selected_category and item.get('brand') == st.session_state.org_selected_brand and item.get('model'))))
            if models:
                for model in models:
                    if st.button(f"âš™ï¸ {model.replace('_', ' ')}", key=f"model_{model}", use_container_width=True):
                        st.session_state.org_selected_model = model
                        st.session_state.org_browse_level = "types"
                        st.rerun()
            else:
                st.info("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î¼Î¿Î½Ï„Î­Î»Î± Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î· Î¼Î¬ÏÎºÎ±.")

        elif st.session_state.org_browse_level == "types":
            st.markdown(f"#### ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±: **{st.session_state.org_selected_category.replace('_', ' ')}** > **{st.session_state.org_selected_brand.replace('_', ' ')}** > **{st.session_state.org_selected_model.replace('_', ' ')}** - Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¤ÏÏ€Î¿ Î•Î³Ï‡ÎµÎ¹ÏÎ¹Î´Î¯Î¿Ï…:")
            types = sorted(list(set(item.get('meta_type') for item in library_data if item.get('category') == st.session_state.org_selected_category and item.get('brand') == st.session_state.org_selected_brand and item.get('model') == st.session_state.org_selected_model and item.get('meta_type'))))
            if types:
                for doc_type in types:
                    if st.button(f"ğŸ“„ {doc_type.replace('_', ' ')}", key=f"type_{doc_type}", use_container_width=True):
                        st.session_state.org_selected_type = doc_type
                        st.session_state.org_browse_level = "files"
                        st.rerun()
            else:
                st.info("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï„ÏÏ€Î¿Î¹ ÎµÎ³Ï‡ÎµÎ¹ÏÎ¹Î´Î¯Ï‰Î½ Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Î¼Î¿Î½Ï„Î­Î»Î¿.")

        elif st.session_state.org_browse_level == "files":
            st.markdown(f"#### ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±: **{st.session_state.org_selected_category.replace('_', ' ')}** > **{st.session_state.org_selected_brand.replace('_', ' ')}** > **{st.session_state.org_selected_model.replace('_', ' ')}** > **{st.session_state.org_selected_type.replace('_', ' ')}** - Î‘ÏÏ‡ÎµÎ¯Î±:")
            files_in_type = [item for item in library_data if item.get('category') == st.session_state.org_selected_category and item.get('brand') == st.session_state.org_selected_brand and item.get('model') == st.session_state.org_selected_model and item.get('meta_type') == st.session_state.org_selected_type]
            
            if files_in_type:
                for file_item in files_in_type:
                    with st.container(border=True):
                        st.markdown(f"**{file_item.get('original_name', file_item.get('name', 'N/A'))}**")
                        if file_item.get('error_codes'):
                            st.caption(f"Error Codes: {file_item.get('error_codes')}")
                        if file_item.get('link'):
                            st.link_button("ğŸ“‚ Î†Î½Î¿Î¹Î³Î¼Î± ÏƒÏ„Î¿ Drive", file_item['link'], use_container_width=True)
                        else:
                            st.caption("No link available.")
            else:
                st.info("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±ÏÏ‡ÎµÎ¯Î± ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿Î½ Ï„ÏÏ€Î¿ ÎµÎ³Ï‡ÎµÎ¹ÏÎ¹Î´Î¯Î¿Ï….")
        
    with tab3: # Manual Review / Errors
        # --- Files for Manual Review / Errors ---
        st.subheader("âš ï¸ Î‘ÏÏ‡ÎµÎ¯Î± Î³Î¹Î± Î§ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î· Î‘Î½Î±Î¸ÎµÏÏÎ·ÏƒÎ· / Î£Ï†Î¬Î»Î¼Î±Ï„Î±")

        # Combine all issue types into a single list for display convenience
        all_issues = []
        
        for item in st.session_state['sorter_manual_review_files']:
            all_issues.append({
                "type": "Manual Review",
                "file": item['file'], 
                "reason": item['reason'], 
                "output": item['output']
            })
        for item in st.session_state['sorter_irrelevant_files']:
            all_issues.append({
                "type": "Irrelevant/Unknown",
                "file": item['file'], 
                "reason": item['reason'], 
                "output": item['output']
            })
        for item in st.session_state['sorter_duplicate_files']:
            all_issues.append({
                "type": "Duplicate",
                "file": item['file'], 
                "reason": item['reason'], 
                "output": item['output']
            })
        for item in st.session_state['sorter_failed_files']:
            all_issues.append({
                "type": "Failed Processing",
                "file": item['file'], 
                "reason": item['reason'], 
                "output": item['output']
            })

        if all_issues:
            for i, issue in enumerate(all_issues):
                file_name = issue['file'].get('name', 'N/A')
                file_id = issue['file'].get('id', 'N/A')
                link = issue['file'].get('webViewLink', f"https://drive.google.com/file/d/{file_id}/view" if file_id != 'N/A' else '#')

                with st.expander(f"ğŸ“ {file_name} - **{issue['type']}**: {issue['reason']}"):
                    st.write(f"**Original File:** `{file_name}`")
                    st.write(f"**Drive ID:** `{file_id}`")
                    st.write(f"**Link:** [Open in Drive]({link})")
                    st.write(f"**AI Output:** `{issue['output']}`")

                    if issue['type'] in ["Manual Review", "Failed Processing", "Irrelevant/Unknown"]:
                        st.markdown("---")
                        st.markdown("**Î§ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î· Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·/Î•Ï€Î±Î½ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±:**")
                        
                        manual_category = st.selectbox(
                            "ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±", ALLOWED_CATEGORIES + ["_MANUAL_REVIEW", "_AI_ERROR", "_NEEDS_OCR", IRRELEVANT_OR_UNKNOWN_FOLDER],
                            index=ALLOWED_CATEGORIES.index("Other_HVAC") if "Other_HVAC" in ALLOWED_CATEGORIES else 0,
                            key=f"manual_cat_{file_id}_{i}"
                        )
                        manual_brand = st.text_input("ÎœÎ¬ÏÎºÎ±", value="UNKNOWN", key=f"manual_brand_{file_id}_{i}")
                        manual_model = st.text_input("ÎœÎ¿Î½Ï„Î­Î»Î¿", value="MISC", key=f"manual_model_{file_id}_{i}")
                        manual_type = st.selectbox(
                            "Î¤ÏÏ€Î¿Ï‚ Î•Î³Ï‡ÎµÎ¹ÏÎ¹Î´Î¯Î¿Ï…", ALLOWED_TYPES, 
                            index=ALLOWED_TYPES.index("General_Manual") if "General_Manual" in ALLOWED_TYPES else 0,
                            key=f"manual_type_{file_id}_{i}"
                        )

                        if st.button("Î•Ï€Î±Î½ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± (Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î±)", key=f"reprocess_{file_id}_{i}", use_container_width=True):
                            manual_data = {
                                "category": manual_category,
                                "brand": manual_brand,
                                "model": manual_model,
                                "type": manual_type
                            }
                            sorter = SorterService()
                            with st.spinner(f"Î•Ï€Î±Î½ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î±ÏÏ‡ÎµÎ¯Î¿Ï…: {file_name}"):
                                sorter.process_unsorted_files(update_ui, specific_file_id=file_id, manual_inputs=manual_data)
                            st.rerun() 
                    else:
                        st.caption("Î‘ÏÏ‡ÎµÎ¯Î± Î´Î¹Ï€Î»ÏŒÏ„Ï…Ï€Ï‰Î½ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶Î¿Î½Ï„Î±Î¹ Î¼Îµ Î¼Î±Î¶Î¹ÎºÎ® Î´Î¹Î±Î³ÏÎ±Ï†Î® Î® Î±ÏÏ‡ÎµÎ¹Î¿Î¸Î­Ï„Î·ÏƒÎ·.")

        else:
            st.info("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÏÏ‡ÎµÎ¯Î± Î³Î¹Î± Î±Î½Î±Î¸ÎµÏÏÎ·ÏƒÎ·.")

    with tab4: # Full Log
        st.subheader(get_text('org_log', lang))
        # Placeholder for the dynamic log messages and progress bar
        progress_bar_placeholder = st.empty()
        log_box = st.container(height=500, border=True)

        # Callback function to update UI in real-time
        def update_ui(msg, type_):
            log_entry = {'msg': msg, 'type': type_}
            st.session_state.sorter_run_log.append(log_entry)
            
            # Display immediately in the log box
            with log_box:
                if type_ == "info": st.info(msg)
                elif type_ == "success": st.success(msg)
                elif type_ == "error": st.error(msg)
                elif type_ == "warning": st.warning(msg)
                else: st.write(f"âš™ï¸ {msg}")
            
            # Update progress bar
            current_progress = st.session_state.sorter_progress_data["current"]
            total_progress = st.session_state.sorter_progress_data["total"]
            progress_text = st.session_state.sorter_progress_data["text"]

            if total_progress > 0:
                progress_value = current_progress / total_progress
                progress_bar_placeholder.progress(progress_value, text=progress_text)
            else:
                progress_bar_placeholder.progress(0, text="Î•ÎºÎºÎ¯Î½Î·ÏƒÎ·...")


        if st.session_state['sorter_running']:
            sorter = SorterService()
            progress_bar_placeholder.progress(0, text="Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·...")
            try:
                sorter.process_unsorted_files(update_ui)
                st.session_state['sorter_running'] = False # Mark as finished
                logger.info("Sorter process completed or stopped. Rerunning UI.")
                st.rerun() # Rerun to update UI after processing is done (will show summary)
            except Exception as e:
                logger.error(f"Error during sorter execution: {e}", exc_info=True)
                update_ui(f"ÎšÏÎ¯ÏƒÎ¹Î¼Î¿ ÏƒÏ†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï„Î¿Ï… Organizer: {e}", "error")
                st.session_state['sorter_running'] = False
                st.rerun()

        # Display accumulated logs after the process is done or on fresh load
        if st.session_state['sorter_run_log']:
            with log_box: 
                log_box.empty() # Clear and re-render to avoid duplicates if rerun
                for log_entry in st.session_state['sorter_run_log']:
                    if log_entry['type'] == 'info': st.info(log_entry['msg'])
                    elif log_entry['type'] == 'success': st.success(log_entry['msg'])
                    elif log_entry['type'] == 'error': st.error(log_entry['msg'])
                    elif log_entry['type'] == 'warning': st.warning(log_entry['msg'])
                    else: st.write(f"âš™ï¸ {log_entry['msg']}")

        # Display final progress state if not running
        if not st.session_state['sorter_running'] and st.session_state.sorter_progress_data["total"] > 0:
            final_progress_value = st.session_state.sorter_progress_data["current"] / st.session_state.sorter_progress_data["total"]
            final_progress_text = st.session_state.sorter_progress_data["text"] 
            progress_bar_placeholder.progress(final_progress_value, text=final_progress_text)