import streamlit as st
import logging
from core.language_pack import get_text
from core.auth_manager import AuthManager
from core.db_connector import DatabaseConnector # Î“Î¹Î± init_local_db
from core.spy_logger import setup_spy, sync_current_spy_logs_to_drive # Î“Î¹Î± Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· logs
from version import VERSION

# Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Ï„Ï‰Î½ UI Modules
from modules import ui_dashboard
from modules import ui_chat
from modules import ui_diagnostics
from modules import ui_search
from modules import ui_clients
from modules import ui_organizer
from modules import ui_tools
from modules import ui_admin_panel
from modules import ui_tech_specs
from modules import ui_help_user
from modules import ui_licensing

# Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Logger Î³Î¹Î± Ï„Î¿ main.py
logger = logging.getLogger("MainApp")

def init_session():
    """
    Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¹Ï‚ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ Ï„Î¿Ï… session state ÎºÎ±Î¹ Ï„Î¿Î½ Spy Logger.
    ÎšÎ±Î½ÏŒÎ½Î±Ï‚ 6: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ initialization keys.
    """
    if 'lang' not in st.session_state:
        st.session_state.lang = 'gr'
    if 'user_info' not in st.session_state:
        st.session_state.user_info = None
    if 'messages' not in st.session_state:
        st.session_state.messages = [] # Î“Î¹Î± Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÏƒÏ…Î½Î¿Î¼Î¹Î»Î¯Î±Ï‚
    if 'page' not in st.session_state:
        st.session_state.page = "Dashboard" # Î ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÏƒÎµÎ»Î¯Î´Î± Î¼ÎµÏ„Î¬ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ·

    # Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î·Ï‚ Ï„Î¿Ï€Î¹ÎºÎ®Ï‚ Î²Î¬ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (SQLite) Î±Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î®Î´Î·
    if 'db_initialized' not in st.session_state:
        if DatabaseConnector.init_local_db():
            st.session_state.db_initialized = True
            logger.info(get_text('db_init_success', st.session_state.lang))
        else:
            st.session_state.db_initialized = False
            logger.error(get_text('db_init_fail', st.session_state.lang))
            st.error(get_text('db_init_fail', st.session_state.lang))

    # Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Ï„Î¿Ï… Spy Logger
    setup_spy()

def main():
    init_session() # Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· session state ÎºÎ±Î¹ logger

    lang = st.session_state.lang # Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î³Î»ÏÏƒÏƒÎ±
    
    # Custom CSS Î³Î¹Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± UI
    st.markdown("""
        <style>
            .stSidebar {
                background-color: #f0f2f6; /* Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ Î³ÎºÏÎ¹ Î³Î¹Î± sidebar */
            }
            .stButton>button {
                width: 100%;
            }
            .chat-input {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: white;
                padding: 1rem;
                border-top: 1px solid #ddd;
                z-index: 999;
            }
            /* Î£Ï„Ï…Î» Î³Î¹Î± Ï„Î¿ Î»Î¿Î³ÏŒÏ„Ï…Ï€Î¿ */
            .logo-img {
                display: block;
                margin-left: auto;
                margin-right: auto;
                width: 80%; /* Î ÏÎ¿ÏƒÎ±ÏÎ¼ÏŒÏƒÏ„Îµ Î±Î½Î¬Î»Î¿Î³Î± */
                max-width: 150px;
                margin-bottom: 20px;
            }
        </style>
    """, unsafe_allow_html=True)

    # --- ÎŸÎ˜ÎŸÎÎ— Î£Î¥ÎÎ”Î•Î£Î—Î£ ---
    if not st.session_state.user_info:
        st.header(f"ğŸ” {get_text('app_title', lang)}")
        
        c_lang, _ = st.columns([1,5])
        with c_lang:
            sel = st.selectbox("ğŸŒ Language", ["Î•Î»Î»Î·Î½Î¹ÎºÎ¬", "English"], index=0 if lang=='gr' else 1, key="login_lang_selector")
            if (st.session_state.lang == 'gr' and sel == "English") or \
               (st.session_state.lang == 'en' and sel == "Î•Î»Î»Î·Î½Î¹ÎºÎ¬"):
                st.session_state.lang = 'gr' if sel == "Î•Î»Î»Î·Î½Î¹ÎºÎ¬" else 'en'
                st.rerun()

        # ÎšÎ±ÏÏ„Î­Î»ÎµÏ‚ Î£ÏÎ½Î´ÎµÏƒÎ·Ï‚/Î•Î³Î³ÏÎ±Ï†Î®Ï‚
        login_tab, register_tab = st.tabs([get_text('login_tab', lang), get_text('register_tab', lang)])

        with login_tab:
            with st.form("login_form"):
                email = st.text_input(get_text('email_lbl', lang), key="login_email")
                password = st.text_input(get_text('pass_lbl', lang), type="password", key="login_password")
                submitted = st.form_submit_button(get_text('btn_login', lang))

                if submitted:
                    user, msg = AuthManager.verify_login(email, password)
                    if msg == "OK":
                        st.session_state.user_info = user
                        logger.info(f"User {user['email']} logged in successfully.")
                        st.success(f"{get_text('dash_welcome', lang)}, {user['name']}!")
                        st.rerun()
                    else:
                        st.error(msg)
                        logger.warning(f"Login failed for {email}: {msg}")

        with register_tab:
            with st.form("register_form"):
                reg_email = st.text_input(get_text('email_lbl', lang), key="register_email")
                reg_name = st.text_input(get_text('name_lbl', lang), key="register_name")
                reg_password = st.text_input(get_text('pass_lbl', lang), type="password", key="register_password")
                submitted = st.form_submit_button(get_text('btn_register', lang))

                if submitted:
                    # COMPLETE: AuthManager.register_new_user call
                    try:
                        if AuthManager.register_new_user(reg_email, reg_name, reg_password):
                            st.success(get_text('reg_success', lang))
                            logger.info(f"User {reg_email} registered successfully as 'pending'.")
                        else:
                            st.error(get_text('reg_fail', lang))
                            logger.warning(f"Registration failed for {reg_email}.")
                    except Exception as e:
                        st.error(f"{get_text('general_ui_error', lang).format(error=e)}")
                        logger.error(f"Registration UI Error: {e}", exc_info=True)
        return # IMPORTANT: exit after login/register if user not authenticated
    
    # --- ÎšÎ¥Î¡Î™Î©Î£ Î Î•Î¡Î™Î’Î‘Î›Î›ÎŸÎ Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—Î£ (ÎœÎµÏ„Î¬ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ·) ---
    st.sidebar.image("assets/logo.png", use_column_width=True, caption=f"Mastro Nek AI {VERSION}")

    # Î“Î»ÏÏƒÏƒÎ± ÏƒÏ„Î¿ Sidebar
    # Move language selection to a more prominent/accessible place if desired, or keep here.
    c_lang_side = st.sidebar.container()
    with c_lang_side:
        lang_sel_side = st.selectbox("ğŸŒ Language", ["Î•Î»Î»Î·Î½Î¹ÎºÎ¬", "English"], index=0 if lang=='gr' else 1, key="sidebar_lang_selector")
        if (st.session_state.lang == 'gr' and lang_sel_side == "English") or \
           (st.session_state.lang == 'en' and lang_sel_side == "Î•Î»Î»Î·Î½Î¹ÎºÎ¬"):
            st.session_state.lang = 'gr' if lang_sel_side == "Î•Î»Î»Î·Î½Î¹ÎºÎ¬" else 'en'
            st.rerun()

    # ÎœÎµÎ½Î¿Ï Î Î»Î¿Î®Î³Î·ÏƒÎ·Ï‚
    st.sidebar.title(get_text('menu_header', lang))
    
    menu_options = {
        "Dashboard": ui_dashboard,
        "AI Chat": ui_chat,
        "Manuals Library": ui_search,
        "Diagnostics": ui_diagnostics,
        "Clients": ui_clients,
        "AI Organizer": ui_organizer,
        "Tools": ui_tools,
        "Tech Specs": ui_tech_specs, # NEW MENU ITEM
        "Help": ui_help_user, # NEW MENU ITEM
        "Licensing Management": ui_licensing, # NEW MENU ITEM
        "Admin": ui_admin_panel,
    }

    # ÎœÎµÏ„Î±Ï†ÏÎ±ÏƒÎ¼Î­Î½ÎµÏ‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚
    translated_options = {get_text(f"menu_{k.lower().replace(' ', '_')}", lang): k for k in menu_options.keys()}
    
    # Check user role for admin panel access
    if st.session_state.user_info and st.session_state.user_info.get('role') != 'admin':
        # Remove Admin, Licensing, Tech Specs for non-admin users
        for key_to_remove in ["Admin", "Licensing Management", "Tech Specs", "AI Organizer"]: # AI Organizer also admin-only
            if get_text(f"menu_{key_to_remove.lower().replace(' ', '_')}", lang) in translated_options:
                del translated_options[get_text(f"menu_{key_to_remove.lower().replace(' ', '_')}", lang)]

    # Streamlit Navigation
    selected_page_translated = st.sidebar.radio(
        "",
        list(translated_options.keys()),
        index=list(translated_options.keys()).index(get_text(f"menu_{st.session_state.page.lower().replace(' ', '_')}", lang)) if get_text(f"menu_{st.session_state.page.lower().replace(' ', '_')}", lang) in translated_options else 0,
        key="main_menu_radio"
    )
    st.session_state.page = translated_options[selected_page_translated] # Store original page name

    # Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·
    if st.sidebar.button(get_text('logout', lang), use_container_width=True):
        sync_current_spy_logs_to_drive() # Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ logs Ï€ÏÎ¹Î½ Ï„Î·Î½ Î±Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·
        st.session_state.user_info = None
        st.session_state.page = "Dashboard" # Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® ÏƒÎµÎ»Î¯Î´Î±
        st.session_state.messages = [] # ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï ÏƒÏ…Î½Î¿Î¼Î¹Î»Î¯Î±Ï‚
        st.session_state.spy_logs = [] # Clear spy logs from session
        logger.info("User logged out.")
        st.rerun()

    # Dynamic UI rendering based on selected page
    try:
        if st.session_state.page in menu_options:
            menu_options[st.session_state.page].render(st.session_state.user_info)
        else:
            ui_dashboard.render(st.session_state.user_info) # Fallback to dashboard
    except Exception as e:
        logger.error(f"UI Rendering Error for page {st.session_state.page}: {e}", exc_info=True)
        st.error(f"{get_text('general_ui_error', lang).format(error=e)}")
    
if __name__ == "__main__":
    main()